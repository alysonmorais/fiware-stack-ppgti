services:
# MONGODB
  mongo-db-fiware:
    image: mongo:4.4
    hostname: mongo-db-fiware
    container_name: mongo-db-fiware
    volumes:
      - ~/volumes-docker/mongo-db-fiware:/data

# ORION CONTEXT BROKER
  orion:
    image: fiware/orion
    hostname: fiware-orion
    container_name: fiware-orion
    depends_on:
      - mongo-db-fiware
    command: -dbURI mongodb://mongo-db-fiware:27017 -logLevel DEBUG

# CYGNUS 
  cygnus:
    image: fiware/cygnus-ngsi
    hostname: cygnus
    container_name: fiware-cygnus
    networks:
      - default
    depends_on:
      - mongo-db-fiware
    environment:
      - "CYGNUS_MONGO_HOSTS=mongo-db-fiware:27017"
      - "CYGNUS_LOG_LEVEL=DEBUG"
      - "CYGNUS_SERVICE_PORT=5051"
      - "CYGNUS_API_PORT=5080"

# NGINX        
  nginx:
     restart: always
     image: nginx
     ports:
      - "80:80"
      - "443:443"
     volumes:
      - ~/volumes-docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ~/volumes-docker/nginx/certificate/nginx-certificate.crt:/etc/nginx/certificate/nginx-certificate.crt:ro
      - ~/volumes-docker/nginx/certificate/nginx.key:/etc/nginx/certificate/nginx.key:ro

# GRAFANA
  grafana:
     image: grafana/grafana
     container_name: grafana
     restart: unless-stopped
     environment:
      - GF_SERVER_ROOT_URL=http://my.grafana.server/
      - GF_PLUGINS_PREINSTALL=grafana-clock-panel
      - GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS=meln5674-mongodb-community
     ports:
      - '3000:3000'
     user: '0'
     volumes:
      - ~/volumes-docker/grafana_storage:/var/lib/grafana

# IoT Agent JSON
  iot-agent:
    image: fiware/iotagent-json
    container_name: iot-agent-json
    restart: always
    depends_on:
      - mongo-db-fiware
      - orion
    environment:
      IOTA_CB_HOST: orion
      IOTA_CB_PORT: 1026
      IOTA_NORTH_PORT: 4041
      IOTA_REGISTRY_TYPE: mongodb
      IOTA_LOG_LEVEL: DEBUG
      IOTA_TIMESTAMP: true
      IOTA_CB_NGSI_VERSION: v2
      IOTA_MONGO_HOST: mongo-db-fiware

# KEYCLOAK
  keycloak:
    image: quay.io/keycloak/keycloak
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin123
      - KC_DB=dev-file
    command: start-dev

# STH-COMET (Short Term History) - CONFIGURAÇÃO CORRIGIDA
  sth-comet:
    image: fiware/sth-comet
    hostname: sth-comet
    container_name: fiware-sth-comet
    depends_on:
      - mongo-db-fiware
    ports:
      - "8666:8666"  # Expondo a porta para debug
    environment:
      - STH_HOST=0.0.0.0
      - STH_PORT=8666
      - DB_PREFIX=sth_
      - DB_URI=mongo-db-fiware:27017
      - LOGOPS_LEVEL=DEBUG
      # Configurações corrigidas
      - DEFAULT_SERVICE=meuservico
      - DEFAULT_SERVICE_PATH=/sensores
      - COLLECTION_PREFIX=sth_
      - DATA_MODEL=collection-per-service-path
      - IGNORE_BLANK_SPACES=true
      - POOL_SIZE=5
      # Configurações adicionais importantes
      - STH_COLLECTION_SIZE=10
      - STH_DB_NAME_ENCODING=false
      # Configurações de timeout para evitar MongoError
      - DB_TIMEOUT=10000
      - DB_POOL_SIZE=5
    restart: unless-stopped
    networks:
      - default

## STH-COMET (Short Term History)_old
#  sth-comet:
#    image: fiware/sth-comet
#    hostname: fiware-sth-comet
#    container_name: fiware-sth-comet
#    depends_on:
#      - mongo-db-fiware
#    environment:
#      - STH_HOST=0.0.0.0
#      - STH_PORT=8666
#      - DB_PREFIX=sth_
#      - DB_URI=mongo-db-fiware:27017
#      - LOGOPS_LEVEL=DEBUG
#      # Configurações adicionais para melhorar performance
#      - DEFAULT_SERVICE=meuservico
#      - DEFAULT_SERVICE_PATH=/sensores
#      - COLLECTION_PREFIX=sth_
#      - DATA_MODEL=collection-per-service-path
#      - IGNORE_BLANK_SPACES=true
#      - POOL_SIZE=5  # Tamanho do pool de conexões MongoDB
#    restart: unless-stopped

# CrateDB
  crate:
    image: crate/crate:latest
    container_name: crate
    command: ["crate", "-Cdiscovery.type=single-node", "-Ccluster.name=docker-cluster", "-Cgateway.expected_nodes=1", "-Cgateway.recover_after_nodes=1"] # Comando mais robusto para single-node
    environment:
      - CRATE_HEAP_SIZE=1g
    volumes:
      - ~/volumes-docker/crate_data:/data
    restart: unless-stopped

# Quantum Leap
  quantumleap:
    image: orchestracities/quantumleap:latest
    container_name: quantumleap
    depends_on:
      - crate
      - orion
    environment:
      - CRATE_HOST=crate
      - QL_CRATE_HOST=crate
      - CRATE_PORT=4200
      - QL_DB_NAME=doc
      - USE_GEOCODING=False
      - LOGLEVEL=INFO
    restart: unless-stopped

networks:
  default:
    labels:
      org.fiware: 'fiware'
volumes:
  nginx:
  mongo-db-fiware:
  grafana_storage:
  crate_data:
